<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Equipment Manual Copilot</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --primary: #1a56db;
      --primary-dark: #1240a8;
      --danger: #e02424;
      --success: #057a55;
      --bg: #f3f4f6;
      --card: #ffffff;
      --border: #d1d5db;
      --text: #111827;
      --muted: #6b7280;
      --sidebar-w: 260px;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .login-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 40px;
      width: 360px;
      box-shadow: 0 4px 24px rgba(0,0,0,.08);
    }
    .login-card h1 { font-size: 1.4rem; margin-bottom: 6px; }
    .login-card p  { color: var(--muted); font-size: .9rem; margin-bottom: 24px; }
    label { display: block; font-size: .85rem; font-weight: 600; margin-bottom: 4px; color: var(--muted); }
    input[type=text], input[type=password], input[type=email], select, textarea {
      width: 100%; padding: 9px 12px; border: 1px solid var(--border);
      border-radius: 8px; font-size: .95rem; outline: none;
      transition: border-color .15s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary); }
    .form-group { margin-bottom: 16px; }
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 9px 18px; border-radius: 8px; border: none;
      font-size: .9rem; font-weight: 600; cursor: pointer; transition: background .15s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-danger  { background: var(--danger); color: #fff; }
    .btn-danger:hover  { background: #b91c1c; }
    .btn-ghost   { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-ghost:hover { background: var(--bg); }
    .btn-sm { padding: 5px 10px; font-size: .8rem; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .error-msg { color: var(--danger); font-size: .85rem; margin-top: 8px; }

    /* ‚îÄ‚îÄ App shell ‚îÄ‚îÄ */
    #app { display: none; height: 100vh; }
    .shell { display: flex; height: 100%; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: var(--sidebar-w);
      background: #1e2637;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    .sidebar-header {
      padding: 20px 16px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sidebar-header h2 { font-size: 1rem; color: #fff; }
    .sidebar-header p  { font-size: .78rem; color: #9ca3af; margin-top: 2px; }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 12px 0; }
    .nav-section { padding: 4px 16px 2px; font-size: .7rem; text-transform: uppercase; letter-spacing: .08em; color: #6b7280; }
    .nav-item {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 16px; cursor: pointer; border-radius: 6px; margin: 1px 6px;
      font-size: .88rem; color: #d1d5db; transition: background .12s;
    }
    .nav-item:hover { background: rgba(255,255,255,.08); }
    .nav-item.active { background: var(--primary); color: #fff; }
    .nav-item svg { flex-shrink: 0; }
    .sidebar-footer {
      padding: 14px 16px;
      border-top: 1px solid rgba(255,255,255,.08);
      font-size: .82rem; color: #9ca3af;
    }
    .sidebar-footer strong { color: #e5e7eb; display: block; }
    .sidebar-footer .logout-btn {
      margin-top: 8px; font-size: .8rem; color: #9ca3af; cursor: pointer;
      background: none; border: none; padding: 0; text-decoration: underline;
    }
    .sidebar-footer .logout-btn:hover { color: #fff; }

    /* ‚îÄ‚îÄ Main content ‚îÄ‚îÄ */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .page { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .page.active { display: flex; }
    .page-header {
      padding: 20px 24px 0;
      border-bottom: 1px solid var(--border);
      background: var(--card);
    }
    .page-header h1 { font-size: 1.3rem; margin-bottom: 4px; }
    .page-header p  { color: var(--muted); font-size: .88rem; padding-bottom: 14px; }
    .page-body { flex: 1; overflow-y: auto; padding: 24px; }

    /* ‚îÄ‚îÄ Chat ‚îÄ‚îÄ */
    #page-chat { background: #f9fafb; }
    .chat-body { flex: 1; overflow-y: auto; padding: 16px 24px; display: flex; flex-direction: column; gap: 16px; }
    .chat-message { display: flex; gap: 12px; max-width: 780px; }
    .chat-message.user { flex-direction: row-reverse; align-self: flex-end; }
    .chat-avatar {
      width: 34px; height: 34px; border-radius: 50%; display: flex;
      align-items: center; justify-content: center; font-size: .8rem; font-weight: 700;
      flex-shrink: 0;
    }
    .chat-message.assistant .chat-avatar { background: var(--primary); color: #fff; }
    .chat-message.user .chat-avatar { background: #374151; color: #fff; }
    .chat-bubble {
      padding: 12px 16px; border-radius: 12px; font-size: .92rem; line-height: 1.55;
      max-width: 640px;
    }
    .chat-message.assistant .chat-bubble { background: var(--card); border: 1px solid var(--border); }
    .chat-message.user .chat-bubble { background: var(--primary); color: #fff; }
    .chat-sources { margin-top: 8px; font-size: .78rem; color: var(--muted); }
    .chat-source-tag {
      display: inline-block; background: #eff6ff; border: 1px solid #bfdbfe;
      color: #1d4ed8; border-radius: 4px; padding: 1px 6px; margin: 2px 3px 2px 0;
      cursor: default;
    }
    .chat-input-area {
      padding: 12px 24px 16px;
      border-top: 1px solid var(--border);
      background: var(--card);
    }
    .chat-input-row { display: flex; gap: 10px; }
    .chat-input-row textarea {
      flex: 1; resize: none; height: 52px; border-radius: 10px;
      font-size: .93rem; padding: 12px 14px;
    }
    .chat-input-row .btn { align-self: flex-end; height: 52px; padding: 0 20px; }
    .typing-indicator { display: flex; gap: 4px; padding: 6px 0; }
    .typing-dot {
      width: 8px; height: 8px; border-radius: 50%; background: var(--muted);
      animation: bounce 1.2s infinite ease-in-out;
    }
    .typing-dot:nth-child(2) { animation-delay: .2s; }
    .typing-dot:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-6px); }
    }
    .chat-empty {
      flex: 1; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 12px; color: var(--muted);
    }
    .chat-empty svg { opacity: .35; }
    .chat-empty h3 { font-size: 1.1rem; color: var(--text); }
    .chat-empty p { font-size: .88rem; text-align: center; max-width: 340px; }
    .chat-suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 8px; }
    .suggestion-chip {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; padding: 6px 14px; font-size: .82rem;
      cursor: pointer; transition: border-color .12s;
    }
    .suggestion-chip:hover { border-color: var(--primary); color: var(--primary); }

    /* ‚îÄ‚îÄ Manuals ‚îÄ‚îÄ */
    .manual-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .manual-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px; display: flex; flex-direction: column; gap: 8px;
    }
    .manual-card-header { display: flex; align-items: center; justify-content: space-between; }
    .unit-badge {
      background: #eff6ff; color: #1d4ed8; border: 1px solid #bfdbfe;
      border-radius: 6px; padding: 2px 8px; font-size: .8rem; font-weight: 700;
    }
    .manual-card-title { font-weight: 600; font-size: .95rem; }
    .manual-card-meta { font-size: .78rem; color: var(--muted); }
    .manual-card-footer { display: flex; gap: 8px; margin-top: 4px; }
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--muted);
    }
    .empty-state h3 { font-size: 1.1rem; color: var(--text); margin-bottom: 6px; }

    /* ‚îÄ‚îÄ Upload modal ‚îÄ‚îÄ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.45);
      display: flex; align-items: center; justify-content: center; z-index: 100;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: var(--card); border-radius: 12px; padding: 28px;
      width: 460px; box-shadow: 0 8px 40px rgba(0,0,0,.18);
    }
    .modal h2 { font-size: 1.1rem; margin-bottom: 18px; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .drop-zone {
      border: 2px dashed var(--border); border-radius: 10px;
      padding: 32px; text-align: center; cursor: pointer;
      color: var(--muted); font-size: .88rem; transition: border-color .15s, background .15s;
    }
    .drop-zone.drag-over { border-color: var(--primary); background: #eff6ff; }
    .drop-zone input[type=file] { display: none; }
    .drop-zone .selected-file { color: var(--text); font-weight: 600; margin-top: 6px; }

    /* ‚îÄ‚îÄ Users ‚îÄ‚îÄ */
    .users-table { width: 100%; border-collapse: collapse; }
    .users-table th, .users-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid var(--border); font-size: .88rem; }
    .users-table th { background: #f9fafb; font-weight: 600; color: var(--muted); font-size: .78rem; text-transform: uppercase; letter-spacing: .05em; }
    .role-badge {
      display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: .75rem; font-weight: 700;
    }
    .role-badge.admin { background: #fef3c7; color: #92400e; }
    .role-badge.user  { background: #d1fae5; color: #065f46; }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    #toast-container {
      position: fixed; bottom: 20px; right: 20px; z-index: 200;
      display: flex; flex-direction: column; gap: 8px;
    }
    .toast {
      padding: 10px 16px; border-radius: 8px; font-size: .88rem; font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,.15); animation: slide-in .2s ease;
      max-width: 320px;
    }
    .toast.success { background: #065f46; color: #fff; }
    .toast.error   { background: #b91c1c; color: #fff; }
    @keyframes slide-in { from { transform: translateX(40px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="login-screen">
  <div class="login-card">
    <h1>üîß Equipment Manual Copilot</h1>
    <p>Sign in to access equipment manuals and chat assistant.</p>
    <div class="form-group">
      <label for="login-username">Username</label>
      <input type="text" id="login-username" placeholder="admin" autocomplete="username" />
    </div>
    <div class="form-group">
      <label for="login-password">Password</label>
      <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="login()">Sign in</button>
    <div id="login-error" class="error-msg" style="display:none"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="app">
  <div class="shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>üîß Manual Copilot</h2>
        <p>Equipment Q&amp;A Assistant</p>
      </div>
      <nav class="sidebar-nav">
        <div class="nav-section">Assistant</div>
        <div class="nav-item active" onclick="showPage('chat')" id="nav-chat">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.9 9.9 0 0 1-4-.83L3 20l1.16-3.65C3.43 15.1 3 13.6 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8Z"/></svg>
          Chat
        </div>
        <div class="nav-section" style="margin-top:8px">Manuals</div>
        <div class="nav-item" onclick="showPage('manuals')" id="nav-manuals">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5.586a1 1 0 0 1 .707.293l5.414 5.414a1 1 0 0 1 .293.707V19a2 2 0 0 1-2 2Z"/></svg>
          Manuals
        </div>
        <div class="nav-item admin-only hidden" onclick="showPage('users')" id="nav-users">
          <svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm8 4a2 2 0 1 0 0-4 2 2 0 0 0 0 4Zm4 4v-1a2 2 0 0 0-2-2h-1"/></svg>
          Users
        </div>
      </nav>
      <div class="sidebar-footer">
        <strong id="sidebar-username"></strong>
        <span id="sidebar-role" class="role-badge" style="margin-top:4px;display:inline-block"></span>
        <br/>
        <button class="logout-btn" onclick="logout()">Sign out</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- CHAT PAGE -->
      <div class="page active" id="page-chat">
        <div class="page-header">
          <h1>Chat with your Manuals</h1>
          <p>Ask about any equipment ‚Äî mention a unit number (e.g. "unit 102") for targeted results.</p>
        </div>
        <div class="chat-body" id="chat-body">
          <div class="chat-empty" id="chat-empty">
            <svg width="56" height="56" fill="none" viewBox="0 0 24 24"><path stroke="#9ca3af" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.9 9.9 0 0 1-4-.83L3 20l1.16-3.65C3.43 15.1 3 13.6 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8Z"/></svg>
            <h3>Ask anything about your equipment</h3>
            <p>Try mentioning a unit number or part name to get started.</p>
            <div class="chat-suggestions">
              <div class="suggestion-chip" onclick="sendSuggestion('What manuals are available?')">What manuals are available?</div>
              <div class="suggestion-chip" onclick="sendSuggestion('Show specs for unit 101')">Show specs for unit 101</div>
              <div class="suggestion-chip" onclick="sendSuggestion('What hoses do I need for unit 102?')">Hoses for unit 102</div>
              <div class="suggestion-chip" onclick="sendSuggestion('Compare oil specs across all units')">Compare oil specs</div>
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <div class="chat-input-row">
            <textarea id="chat-input" placeholder="Ask a question‚Ä¶ (e.g. 'What hoses does unit 102 need?')" onkeydown="chatKeydown(event)"></textarea>
            <button class="btn btn-primary" id="send-btn" onclick="sendMessage()">
              <svg width="18" height="18" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="m22 2-7 20-4-9-9-4 20-7Z"/></svg>
              Send
            </button>
          </div>
        </div>
      </div>

      <!-- MANUALS PAGE -->
      <div class="page" id="page-manuals">
        <div class="page-header">
          <h1>Equipment Manuals</h1>
          <p>Upload, browse, and manage PDF manuals. Each manual is assigned a unit number.</p>
        </div>
        <div class="page-body">
          <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
            <button class="btn btn-primary" onclick="openUploadModal()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M12 5v14m-7-7 7-7 7 7"/></svg>
              Upload Manual
            </button>
          </div>
          <div id="manuals-list" class="manual-grid"></div>
        </div>
      </div>

      <!-- USERS PAGE (admin only) -->
      <div class="page" id="page-users">
        <div class="page-header">
          <h1>User Management</h1>
          <p>Add or remove users who can access this copilot. Admins can manage manuals and users.</p>
        </div>
        <div class="page-body">
          <div style="display:flex;justify-content:flex-end;margin-bottom:20px">
            <button class="btn btn-primary" onclick="openAddUserModal()">
              <svg width="16" height="16" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M12 5v14m-7-7 7-7 7 7"/></svg>
              Add User
            </button>
          </div>
          <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;overflow:hidden">
            <table class="users-table">
              <thead><tr><th>Username</th><th>Role</th><th></th></tr></thead>
              <tbody id="users-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- ‚îÄ‚îÄ Upload Modal ‚îÄ‚îÄ -->
<div class="modal-overlay hidden" id="upload-modal">
  <div class="modal">
    <h2>üìÑ Upload Equipment Manual</h2>
    <div class="form-group">
      <label>Unit Number *</label>
      <input type="text" id="upload-unit" placeholder="e.g. 102" />
    </div>
    <div class="form-group">
      <label>Description (optional)</label>
      <input type="text" id="upload-desc" placeholder="e.g. Hydraulic excavator 2020" />
    </div>
    <div class="form-group">
      <label>PDF File *</label>
      <div class="drop-zone" id="drop-zone" onclick="document.getElementById('upload-file').click()" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="dropFile(event)">
        <input type="file" id="upload-file" accept=".pdf" onchange="fileChosen(event)" />
        <svg width="32" height="32" fill="none" viewBox="0 0 24 24" style="margin:0 auto 8px;display:block"><path stroke="#9ca3af" stroke-width="1.5" d="M12 16V4m0 0-3 3m3-3 3 3M4 20h16"/></svg>
        <div>Click or drag a PDF here</div>
        <div class="selected-file" id="selected-file-name" style="display:none"></div>
      </div>
    </div>
    <div id="upload-error" class="error-msg" style="display:none"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeUploadModal()">Cancel</button>
      <button class="btn btn-primary" id="upload-submit-btn" onclick="submitUpload()">Upload & Index</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Add User Modal ‚îÄ‚îÄ -->
<div class="modal-overlay hidden" id="add-user-modal">
  <div class="modal">
    <h2>üë§ Add User</h2>
    <div class="form-group">
      <label>Username *</label>
      <input type="text" id="new-username" />
    </div>
    <div class="form-group">
      <label>Password *</label>
      <input type="password" id="new-password" />
    </div>
    <div class="form-group">
      <label>Role</label>
      <select id="new-role">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
    </div>
    <div id="add-user-error" class="error-msg" style="display:none"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeAddUserModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitAddUser()">Create User</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _token = localStorage.getItem('token') || '';
let _user  = null;
let _chatHistory = [];
let _uploadFile  = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function api(method, path, body, isForm=false) {
  const headers = {};
  if (_token) headers['Authorization'] = `Bearer ${_token}`;
  if (!isForm && body) headers['Content-Type'] = 'application/json';
  const res = await fetch(path, {
    method,
    headers,
    body: isForm ? body : (body ? JSON.stringify(body) : undefined),
  });
  if (!res.ok) {
    let msg = `HTTP ${res.status}`;
    try { const j = await res.json(); msg = j.detail || msg; } catch {}
    throw new Error(msg);
  }
  if (res.status === 204) return null;
  return res.json();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUTH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  const errEl = document.getElementById('login-error');
  errEl.style.display = 'none';
  try {
    const fd = new FormData();
    fd.append('username', username);
    fd.append('password', password);
    const res = await fetch('/api/auth/token', { method: 'POST', body: fd });
    if (!res.ok) { const j = await res.json(); throw new Error(j.detail || 'Login failed'); }
    const data = await res.json();
    _token = data.access_token;
    localStorage.setItem('token', _token);
    await initApp();
  } catch(e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  }
}

document.getElementById('login-password').addEventListener('keydown', e => { if (e.key === 'Enter') login(); });

async function initApp() {
  try {
    _user = await api('GET', '/api/auth/me');
  } catch {
    logout(); return;
  }
  document.getElementById('sidebar-username').textContent = _user.username;
  const roleBadge = document.getElementById('sidebar-role');
  roleBadge.textContent = _user.role;
  roleBadge.className = `role-badge ${_user.role}`;

  // Show admin-only items
  document.querySelectorAll('.admin-only').forEach(el => {
    el.classList.toggle('hidden', _user.role !== 'admin');
  });

  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadManuals();
  if (_user.role === 'admin') loadUsers();
}

function logout() {
  _token = '';
  localStorage.removeItem('token');
  _user = null;
  _chatHistory = [];
  document.getElementById('app').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  // Reset chat state
  _chatHistory = [];
  const chatBody = document.getElementById('chat-body');
  chatBody.innerHTML = `<div class="chat-empty" id="chat-empty">
    <svg width="56" height="56" fill="none" viewBox="0 0 24 24"><path stroke="#9ca3af" stroke-width="1.5" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.9 9.9 0 0 1-4-.83L3 20l1.16-3.65C3.43 15.1 3 13.6 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8Z"/></svg>
    <h3>Ask anything about your equipment</h3>
    <p>Try mentioning a unit number or part name to get started.</p>
    <div class="chat-suggestions">
      <div class="suggestion-chip" onclick="sendSuggestion('What manuals are available?')">What manuals are available?</div>
      <div class="suggestion-chip" onclick="sendSuggestion('Show specs for unit 101')">Show specs for unit 101</div>
      <div class="suggestion-chip" onclick="sendSuggestion('What hoses do I need for unit 102?')">Hoses for unit 102</div>
      <div class="suggestion-chip" onclick="sendSuggestion('Compare oil specs across all units')">Compare oil specs</div>
    </div>
  </div>`;
}

// Auto-login if token exists
if (_token) initApp();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById(`page-${name}`).classList.add('active');
  document.getElementById(`nav-${name}`).classList.add('active');
  if (name === 'manuals') loadManuals();
  if (name === 'users') loadUsers();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function chatKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function sendSuggestion(text) {
  document.getElementById('chat-input').value = text;
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';

  // Remove empty state
  const empty = document.getElementById('chat-empty');
  if (empty) empty.remove();

  appendMessage('user', msg, []);
  _chatHistory.push({ role: 'user', content: msg });

  const typingId = appendTyping();
  document.getElementById('send-btn').disabled = true;

  try {
    const res = await api('POST', '/api/chat', { message: msg, history: _chatHistory.slice(-20) });
    removeTyping(typingId);
    appendMessage('assistant', res.answer, res.sources);
    _chatHistory.push({ role: 'assistant', content: res.answer });
  } catch(e) {
    removeTyping(typingId);
    appendMessage('assistant', `‚ö†Ô∏è Error: ${e.message}`, []);
  } finally {
    document.getElementById('send-btn').disabled = false;
    input.focus();
  }
}

function appendMessage(role, text, sources) {
  const body = document.getElementById('chat-body');
  const div = document.createElement('div');
  div.className = `chat-message ${role}`;
  const initials = role === 'assistant' ? 'AI' : (_user?.username?.[0] || 'U').toUpperCase();
  let sourcesHtml = '';
  if (sources && sources.length) {
    const tags = sources.map(s => `<span class="chat-source-tag" title="${escHtml(s.text)}">Unit ${escHtml(s.unit_number)} ¬∑ p${s.page}</span>`).join('');
    sourcesHtml = `<div class="chat-sources">Sources: ${tags}</div>`;
  }
  div.innerHTML = `
    <div class="chat-avatar">${initials}</div>
    <div>
      <div class="chat-bubble">${formatText(text)}</div>
      ${sourcesHtml}
    </div>`;
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
  return div;
}

let _typingCounter = 0;
function appendTyping() {
  const id = ++_typingCounter;
  const body = document.getElementById('chat-body');
  const div = document.createElement('div');
  div.className = 'chat-message assistant';
  div.id = `typing-${id}`;
  div.innerHTML = `
    <div class="chat-avatar">AI</div>
    <div class="chat-bubble">
      <div class="typing-indicator">
        <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
      </div>
    </div>`;
  body.appendChild(div);
  body.scrollTop = body.scrollHeight;
  return id;
}

function removeTyping(id) {
  const el = document.getElementById(`typing-${id}`);
  if (el) el.remove();
}

function formatText(t) {
  // Basic markdown-like formatting
  return escHtml(t)
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`(.+?)`/g, '<code style="background:#f3f4f6;padding:1px 4px;border-radius:3px">$1</code>')
    .replace(/\n/g, '<br/>');
}

function escHtml(t) {
  return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MANUALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadManuals() {
  const container = document.getElementById('manuals-list');
  container.innerHTML = '<p style="color:var(--muted)">Loading‚Ä¶</p>';
  try {
    const data = await api('GET', '/api/manuals');
    if (!data.manuals.length) {
      container.innerHTML = `<div class="empty-state"><h3>No manuals uploaded yet</h3><p>Click "Upload Manual" to add your first PDF.</p></div>`;
      return;
    }
    container.innerHTML = data.manuals.map(m => `
      <div class="manual-card">
        <div class="manual-card-header">
          <span class="unit-badge">Unit ${escHtml(m.unit_number)}</span>
          <span class="manual-card-meta">${m.page_count} pages</span>
        </div>
        <div class="manual-card-title">${escHtml(m.filename)}</div>
        ${m.description ? `<div class="manual-card-meta">${escHtml(m.description)}</div>` : ''}
        <div class="manual-card-meta">Uploaded ${new Date(m.uploaded_at).toLocaleDateString()} by ${escHtml(m.uploaded_by)}</div>
        <div class="manual-card-footer">
          <a href="/api/manuals/${encodeURIComponent(m.unit_number)}/download" target="_blank" class="btn btn-ghost btn-sm">
            <svg width="12" height="12" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M12 16v-4m0 0V4m0 8-3 3m3-3 3 3M4 20h16"/></svg>
            Download
          </a>
          <button class="btn btn-ghost btn-sm" onclick="chatAboutUnit('${escHtml(m.unit_number)}')">Chat</button>
          ${_user?.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteManual('${escHtml(m.unit_number)}')">Delete</button>` : ''}
        </div>
      </div>`).join('');
  } catch(e) {
    container.innerHTML = `<p style="color:var(--danger)">Error: ${e.message}</p>`;
  }
}

function chatAboutUnit(unit) {
  document.getElementById('chat-input').value = `Tell me about unit ${unit}`;
  showPage('chat');
}

async function deleteManual(unit) {
  if (!confirm(`Delete manual for Unit ${unit}? This cannot be undone.`)) return;
  try {
    await api('DELETE', `/api/manuals/${encodeURIComponent(unit)}`);
    toast('Manual deleted', 'success');
    loadManuals();
  } catch(e) {
    toast(`Error: ${e.message}`, 'error');
  }
}

// ‚îÄ‚îÄ Upload modal ‚îÄ‚îÄ
function openUploadModal() {
  _uploadFile = null;
  document.getElementById('upload-unit').value = '';
  document.getElementById('upload-desc').value = '';
  document.getElementById('upload-file').value = '';
  document.getElementById('selected-file-name').style.display = 'none';
  document.getElementById('upload-error').style.display = 'none';
  document.getElementById('upload-modal').classList.remove('hidden');
}
function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }

function dragOver(e) { e.preventDefault(); document.getElementById('drop-zone').classList.add('drag-over'); }
function dragLeave()  { document.getElementById('drop-zone').classList.remove('drag-over'); }
function dropFile(e)  {
  e.preventDefault();
  dragLeave();
  const f = e.dataTransfer.files[0];
  if (f && f.name.endsWith('.pdf')) setUploadFile(f);
}
function fileChosen(e) { if (e.target.files[0]) setUploadFile(e.target.files[0]); }
function setUploadFile(f) {
  _uploadFile = f;
  const el = document.getElementById('selected-file-name');
  el.textContent = f.name;
  el.style.display = 'block';
}

async function submitUpload() {
  const unit = document.getElementById('upload-unit').value.trim();
  const desc = document.getElementById('upload-desc').value.trim();
  const errEl = document.getElementById('upload-error');
  errEl.style.display = 'none';
  if (!unit) { errEl.textContent = 'Unit number is required'; errEl.style.display = 'block'; return; }
  if (!_uploadFile) { errEl.textContent = 'Please select a PDF file'; errEl.style.display = 'block'; return; }
  const btn = document.getElementById('upload-submit-btn');
  btn.disabled = true; btn.textContent = 'Uploading‚Ä¶';
  try {
    const fd = new FormData();
    fd.append('unit_number', unit);
    if (desc) fd.append('description', desc);
    fd.append('file', _uploadFile);
    await api('POST', '/api/manuals', fd, true);
    toast(`Manual for Unit ${unit} uploaded and indexed!`, 'success');
    closeUploadModal();
    loadManuals();
  } catch(e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Upload & Index';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê USERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadUsers() {
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = '<tr><td colspan="3" style="color:var(--muted)">Loading‚Ä¶</td></tr>';
  try {
    const users = await api('GET', '/api/auth/users');
    tbody.innerHTML = users.map(u => `
      <tr>
        <td>${escHtml(u.username)}</td>
        <td><span class="role-badge ${u.role}">${u.role}</span></td>
        <td>
          ${u.username !== _user?.username
            ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${escHtml(u.username)}')">Remove</button>`
            : '<span style="color:var(--muted);font-size:.8rem">You</span>'}
        </td>
      </tr>`).join('');
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="3" style="color:var(--danger)">${e.message}</td></tr>`;
  }
}

function openAddUserModal() {
  document.getElementById('new-username').value = '';
  document.getElementById('new-password').value = '';
  document.getElementById('new-role').value = 'user';
  document.getElementById('add-user-error').style.display = 'none';
  document.getElementById('add-user-modal').classList.remove('hidden');
}
function closeAddUserModal() { document.getElementById('add-user-modal').classList.add('hidden'); }

async function submitAddUser() {
  const username = document.getElementById('new-username').value.trim();
  const password = document.getElementById('new-password').value;
  const role     = document.getElementById('new-role').value;
  const errEl    = document.getElementById('add-user-error');
  errEl.style.display = 'none';
  if (!username || !password) { errEl.textContent = 'Username and password are required'; errEl.style.display = 'block'; return; }
  try {
    await api('POST', '/api/auth/users', { username, password, role });
    toast(`User "${username}" created`, 'success');
    closeAddUserModal();
    loadUsers();
  } catch(e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  }
}

async function deleteUser(username) {
  if (!confirm(`Remove user "${username}"?`)) return;
  try {
    await api('DELETE', `/api/auth/users/${encodeURIComponent(username)}`);
    toast(`User "${username}" removed`, 'success');
    loadUsers();
  } catch(e) {
    toast(`Error: ${e.message}`, 'error');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type='success') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(() => el.remove(), 3500);
}
</script>
</body>
</html>
